<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Сертификат участника</title>
    <style>
        * {
            box-sizing: border-box;
            font-family: 'Georgia', 'Times New Roman', serif;
        }

        body {
            background: linear-gradient(145deg, #f0e9d8 0%, #dacba8 100%);
            min-height: 100vh;
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: rgba(255, 250, 240, 0.9);
            backdrop-filter: blur(5px);
            border-radius: 40px;
            box-shadow: 0 20px 30px rgba(0, 0, 0, 0.3), inset 0 0 10px #fff3cf;
            padding: 30px;
            width: 100%;
            max-width: 800px;
            border: 2px solid #b49b6b;
        }

        h1 {
            text-align: center;
            margin: 0 0 10px;
            font-size: 2.2rem;
            color: #3d2b1a;
            text-shadow: 2px 2px 0 #cbaa7a, 4px 4px 0 #5e3e1f;
            letter-spacing: 4px;
        }

        .sub {
            text-align: center;
            font-style: italic;
            color: #4a3720;
            margin-bottom: 20px;
            font-size: 1.1rem;
        }

        .canvas-wrapper {
            background: #32281b;
            padding: 15px;
            border-radius: 30px;
            box-shadow: inset 0 0 10px #1f140e, 0 10px 15px #00000055;
            margin-bottom: 20px;
        }

        canvas {
            display: block;
            width: 100%;
            height: auto;
            border-radius: 20px;
            box-shadow: 0 0 0 2px #e2c28b, 0 0 0 5px #936e3e;
            background: #fff9e6;
        }

        .control-panel {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            align-items: center;
            justify-content: center;
            background: #eedbbc;
            padding: 20px;
            border-radius: 60px;
            border: 1px solid #b4915c;
        }

        .input-group {
            display: flex;
            align-items: center;
            gap: 8px;
            background: white;
            padding: 8px 20px;
            border-radius: 50px;
            border: 2px solid #8b6b41;
            flex: 2 1 250px;
        }

        .input-group label {
            font-weight: bold;
            color: #3d2b1a;
            font-size: 1.5rem;
        }

        .input-group input {
            border: none;
            padding: 8px 5px;
            font-size: 1.2rem;
            width: 100%;
            background: transparent;
            outline: none;
            font-family: 'Courier New', monospace;
            font-weight: bold;
        }

        button {
            background: #7e5a38;
            border: none;
            color: #ffefd0;
            font-weight: bold;
            font-size: 1.2rem;
            padding: 12px 30px;
            border-radius: 50px;
            cursor: pointer;
            box-shadow: 0 5px 0 #3e2a17, 0 8px 12px black;
            transition: 0.1s;
            letter-spacing: 1px;
            flex: 1 0 auto;
            border: 1px solid #cfa668;
        }

        button:hover {
            background: #9e784e;
            transform: translateY(-2px);
            box-shadow: 0 7px 0 #3e2a17, 0 10px 15px black;
        }

        button:active {
            transform: translateY(5px);
            box-shadow: 0 2px 0 #3e2a17, 0 5px 10px black;
        }

        button:disabled {
            opacity: 0.5;
            pointer-events: none;
            transform: none;
            box-shadow: 0 5px 0 #3e2a17;
        }
    </style>
</head>
<body>
<div class="container">
    <h1>СЕРТИФИКАТ УЧАСТНИКА</h1>
    <div class="sub">введите имя и скачайте сертификат</div>

    <div class="canvas-wrapper">
        <canvas id="certCanvas"></canvas>
    </div>

    <div class="control-panel">
        <div class="input-group">
            <label>⭐</label>
            <input type="text" id="nameInput" placeholder="Имя и фамилия" value="">
        </div>
        <button id="downloadBtn">⬇ Скачать</button>
    </div>
</div>

<script>
    (function() {
        const canvas = document.getElementById('certCanvas');
        const ctx = canvas.getContext('2d');
        const nameInput = document.getElementById('nameInput');
        const downloadBtn = document.getElementById('downloadBtn');

        // Параметры текста на сертификате
        const TEXT_X_PERCENT = 0.50;
        const TEXT_Y_PERCENT = 0.46;
        const FONT_SIZE_PERCENT = 0.04;

        // URL вашего веб-приложения Google Apps Script
        const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbz8omxGnZB0TX5BjGsYPPnWYzk3kk_8dl8KBmn8lx8eFxpBne1gPu2_tX-jabHtvRfOfA/exec';

        // Массив записей и localStorage (нужен для нумерации)
        let records = [];
        const STORAGE_KEY = 'certificate_history';

        // Переменные для изображения
        let image = new Image();
        let imageLoaded = false;      // true, когда хотя бы одно изображение загружено
        let loadFailed = false;       // true, если все источники перебраны и ни один не загрузился

        // Список источников для последовательной загрузки
        const imageSources = [
            'https://i.ibb.co/mC6JmSSs/gramota.png',
            'https://raw.githubusercontent.com/Vanes61752/23FFF/refs/heads/main/gramota.png',
            'gramota.png'   // локальный файл в той же папке
        ];

        // Загружаем сохранённые записи
        function loadRecords() {
            const stored = localStorage.getItem(STORAGE_KEY);
            if (stored) {
                try {
                    records = JSON.parse(stored);
                } catch (e) {
                    records = [];
                }
            } else {
                records = [];
            }
        }

        // Сохраняем записи в localStorage
        function saveRecords() {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(records));
        }

        // Добавление новой записи в локальную историю (только для нумерации)
        function addLocalRecord(name) {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const dateTime = `${year}-${month}-${day} ${hours}:${minutes}`;
            
            const newRecord = {
                number: records.length + 1,
                name: name.trim() || 'Аноним',
                datetime: dateTime
            };
            records.push(newRecord);
            saveRecords();
        }

        // Функция получения IP через ipify
        async function getIP() {
            try {
                const response = await fetch('https://api.ipify.org?format=json');
                const data = await response.json();
                return data.ip;
            } catch (e) {
                console.error('Не удалось получить IP', e);
                return 'unknown';
            }
        }

        // Функция отправки данных в Google Apps Script
        async function sendToGoogleScript(data) {
            const params = new URLSearchParams();
            params.append('number', data.number);
            params.append('name', data.name);
            params.append('ip', data.ip);
            params.append('userAgent', data.userAgent);
            params.append('referrer', data.referrer);
            params.append('datetime', data.datetime);

            try {
                await fetch(GOOGLE_SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: params
                });
                console.log('Данные отправлены в Google Sheets');
            } catch (e) {
                console.error('Ошибка отправки в Google Sheets:', e);
            }
        }

        // Отрисовка сертификата с текущим именем (если изображение загружено)
        function drawCertificate(name) {
            if (!imageLoaded) return; // ничего не рисуем, если нет фона

            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.drawImage(image, 0, 0, canvas.width, canvas.height);

            if (name.trim() !== '') {
                const x = canvas.width * TEXT_X_PERCENT;
                const y = canvas.height * TEXT_Y_PERCENT;
                const fontSize = canvas.height * FONT_SIZE_PERCENT;

                ctx.font = `bold italic ${fontSize}px "Georgia", "Times New Roman", serif`;
                ctx.fillStyle = '#2c1e0e';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.shadowColor = '#f9eac0';
                ctx.shadowBlur = 10;
                ctx.shadowOffsetX = 2;
                ctx.shadowOffsetY = 2;

                ctx.fillText(name, x, y);

                ctx.shadowColor = 'transparent';
                ctx.shadowBlur = 0;
                ctx.shadowOffsetX = 0;
                ctx.shadowOffsetY = 0;
            }
        }

        // Функция для рисования сообщения об ошибке (когда все источники не загрузились)
        function drawErrorMessage(message) {
            // Устанавливаем размер canvas (можно задать фиксированный или пропорциональный)
            canvas.width = 800;  // примерная ширина
            canvas.height = 600; // примерная высота
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = '#f8f0d5';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.strokeStyle = '#b49b6b';
            ctx.lineWidth = 10;
            ctx.strokeRect(10, 10, canvas.width-20, canvas.height-20);

            ctx.font = 'bold 32px Georgia';
            ctx.fillStyle = '#4d2e1b';
            ctx.textAlign = 'center';
            ctx.fillText('СЕРТИФИКАТ УЧАСТНИКА', canvas.width/2, 100);

            ctx.font = '24px Arial';
            ctx.fillStyle = '#a12f2f';
            ctx.fillText(message, canvas.width/2, canvas.height/2);
        }

        // Рекурсивная функция загрузки изображения из списка источников
        function tryLoadImage(sourceIndex) {
            if (sourceIndex >= imageSources.length) {
                // Все источники перебраны, ни один не загрузился
                console.error('Не удалось загрузить изображение ни из одного источника');
                loadFailed = true;
                imageLoaded = false;
                downloadBtn.disabled = true; // блокируем кнопку
                drawErrorMessage('Свяжитесь с администрацией');
                return;
            }

            const url = imageSources[sourceIndex];
            console.log(`Пытаемся загрузить изображение из: ${url}`);

            const tempImage = new Image();
            tempImage.crossOrigin = 'anonymous'; // для CORS

            tempImage.onload = function() {
                console.log(`Успешно загружено из: ${url}`);
                // Сохраняем загруженное изображение в глобальную переменную
                image = tempImage;
                imageLoaded = true;
                loadFailed = false;
                downloadBtn.disabled = false; // разблокируем кнопку на всякий случай

                // Устанавливаем размер canvas равным размеру изображения
                canvas.width = image.width;
                canvas.height = image.height;

                // Рисуем сертификат с текущим именем
                drawCertificate(nameInput.value);
            };

            tempImage.onerror = function() {
                console.warn(`Не удалось загрузить из: ${url}, пробуем следующий источник...`);
                // Пробуем следующий источник
                tryLoadImage(sourceIndex + 1);
            };

            tempImage.src = url;
        }

        // Запускаем попытки загрузки
        tryLoadImage(0);

        // При изменении имени перерисовываем сертификат, если фон загружен
        nameInput.addEventListener('input', function() {
            if (imageLoaded) {
                drawCertificate(nameInput.value);
            } else if (loadFailed) {
                // Если загрузка окончательно не удалась, уже показывается ошибка
                // Можно ничего не делать
            }
        });

        // Обработчик кнопки скачивания
        downloadBtn.addEventListener('click', async function() {
            if (!imageLoaded) {
                if (loadFailed) {
                    alert('Фон сертификата не загружен. Свяжитесь с администрацией.');
                } else {
                    alert('Изображение ещё загружается. Подождите несколько секунд и попробуйте снова.');
                }
                return;
            }

            // Получаем IP
            const ip = await getIP();

            // Формируем данные для отправки
            const now = new Date();
            const datetime = now.toLocaleString();
            const userName = nameInput.value.trim() || 'Аноним';
            const recordNumber = records.length + 1;

            const logData = {
                number: recordNumber,
                name: userName,
                ip: ip,
                userAgent: navigator.userAgent,
                referrer: document.referrer || 'прямой заход',
                datetime: datetime
            };

            // Отправляем данные в Google
            sendToGoogleScript(logData);

            // Добавляем запись в локальную историю (для сохранения номера)
            addLocalRecord(userName);

            // Отрисовываем сертификат с именем (на всякий случай)
            drawCertificate(userName);

            // Скачиваем PNG
            try {
                const dataURL = canvas.toDataURL('image/png');
                const link = document.createElement('a');
                const fileName = userName.replace(/[^a-zа-яё0-9]/gi, '_');
                link.download = 'Сертификат_' + fileName + '.png';
                link.href = dataURL;
                link.click();
            } catch (e) {
                alert('Не удалось скачать, напишие администратору.');
                console.error(e);
            }
        });

        // Загружаем историю при старте (чтобы знать следующий номер)
        loadRecords();
    })();
</script>
</body>
</html>